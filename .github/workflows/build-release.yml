name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Determine build metadata
        id: meta
        run: |
          python - <<'PY'
          import os
          import xml.etree.ElementTree as ET
          import re

          tree = ET.parse('pom.xml')
          root = tree.getroot()
          ns = {'m': 'http://maven.apache.org/POM/4.0.0'}

          def get_text(path):
            node = root.find(path, ns)
            return node.text.strip() if node is not None and node.text else None

          artifact_id = get_text('m:artifactId')
          project_version = get_text('m:version')

          version_text = None
          for dep in root.findall('.//m:dependency', ns):
            artifact = dep.find('m:artifactId', ns)
            if artifact is not None and artifact.text == 'paper-api':
              ver = dep.find('m:version', ns)
              if ver is not None and ver.text:
                version_text = ver.text.strip()
                break

          if not version_text:
            raise SystemExit('paper-api version not found in pom.xml')

          match = re.match(r'(\d+\.\d+(?:\.\d+)?)', version_text)
          if not match:
            raise SystemExit(f'Could not parse Minecraft version from {version_text}')

          mc_version = match.group(1)
          output_path = os.environ.get('GITHUB_OUTPUT')
          if not output_path:
            raise SystemExit('GITHUB_OUTPUT is not set')
          with open(output_path, 'a', encoding='utf-8') as fh:
            fh.write(f"mc_version={mc_version}\n")
            fh.write(f"artifact_id={artifact_id}\n")
            fh.write(f"project_version={project_version}\n")
          PY

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Prepare release asset
        id: asset
        run: |
          RELEASE_ID="${{ steps.meta.outputs.mc_version }}-${{ github.run_number }}"
          PROJECT_NAME="${{ steps.meta.outputs.artifact_id }}"
          PROJECT_VERSION="${{ steps.meta.outputs.project_version }}"
          JAR_PATH="target/${PROJECT_NAME}-${PROJECT_VERSION}.jar"
          if [ ! -f "$JAR_PATH" ]; then
            JAR_PATH=$(ls target/*.jar | grep -v 'original-' | head -n 1)
          fi
          OUT_JAR="${PROJECT_NAME}-${RELEASE_ID}.jar"
          cp "$JAR_PATH" "$OUT_JAR"
          if [ "${{ github.ref_type }}" = "tag" ]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME="${PROJECT_NAME}-${RELEASE_ID}"
          fi
          echo "release_id=$RELEASE_ID" >> "$GITHUB_OUTPUT"
          echo "asset=$OUT_JAR" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ steps.asset.outputs.tag_name }}"
          name: "${{ steps.asset.outputs.tag_name }}"
          files: "${{ steps.asset.outputs.asset }}"
